{% extends "pipeline_layout.html" %}
{% block title %}
Pipeline di progetto
{% endblock %}
{% block content %}
{% load static %}

<div class="container_form_no_flex gap-[20px] pb-[60px]">
   <!-- 1. Preparazione dati -->
    <div class="flex items-center border-b border-gray-200 border-opacity-10">
        <p class="p stint" id="prepDataStatus">
            <span class="title_pipeline">Preparazione dati</span>
            <span id="prepDataState" class="stint status-text">In attesa</span>
            <div id="prepDataLoader" class="stint loader hidden_my"></div>
            <i id="prepDataErrorIcon" class="fa-light fa-xmark icona stint hidden_my"></i>
        </p>
    </div>

    <!-- 2. Dimensionamento -->
    <div class="flex items-center border-b border-gray-200 border-opacity-10">
        <p class="p stint" id="sizingStatus">
            <span class="title_pipeline">Dimensionamento</span>
            <span id="sizingState" class="stint status-text">In attesa</span>
            <div id="sizingLoader" class="stint loader hidden_my"></div>
            <i id="sizingErrorIcon" class="fa-light fa-xmark icona stint hidden_my"></i>
        </p>
   </div>

    <!-- 2. Calcolatore solare -->
    <div class="flex items-center border-b border-gray-200 border-opacity-10">
        <p class="p stint" id="solarCalculatorStatus">
            <span class="title_pipeline">Calcolatore solare</span>
            <span id="solarCalculatorState" class="stint status-text">In attesa</span>
            <div id="solarCalculatorLoader" class="stint loader hidden_my"></div>
            <i id="solarCalculatorErrorIcon" class="fa-light fa-xmark icona stint hidden_my"></i>

        </p>
    </div>
   
    <!-- 3. ProducibilitÃ  -->




   <!-- 5. Pvgis -->
   <div class="flex items-center border-b border-gray-200 border-opacity-10">
        <p class="p stint" id="pvgisStatus">
            <span class="title_pipeline">Pvgis</span>
            <span id="pvgisState" class="stint status-text">In attesa</span>
            <div id="pvgisLoader" class="stint loader hidden_my"></div>
            <i id="pvgisErrorIcon" class="fa-light fa-xmark icona stint hidden_my"></i>
        </p>
   </div> 

   <div class="flex items-center border-b border-gray-200 border-opacity-10">
        <p class="p stint" id="cashflowStatus">
            <span class="title_pipeline">Analisi economica finanziaria</span>
            <span id="cashflowState" class="stint status-text">In attesa</span>
            <div id="cashflowLoader" class="stint loader hidden_my"></div>
        <i id="cashflowErrorIcon" class="fa-light fa-xmark icona stint hidden_my"></i>
    </p>
</div> 
   
   <!-- 6. Generatore Fotovoltaico -->
   <div class="flex items-center border-b border-gray-200 border-opacity-10">
        <p class="p stint" id="pvGeneratorStatus">
            <span class="title_pipeline">Generatore fotovoltaico</span>
            <span id="pvGeneratorState" class="stint status-text">In attesa</span>
            <div id="pvGeneratorLoader" class="stint loader hidden_my"></div>
            <i id="pvGeneratorErrorIcon" class="fa-light fa-xmark icona stint hidden_my"></i>
        </p>
   </div>

   <!-- 7. Verifiche Tecniche -->
   <div class="flex items-center border-b border-gray-200 border-opacity-10">
        <p class="p stint" id="technicalChecksStatus">
            <span class="title_pipeline">Verifiche tecniche</span>
            <span id="technicalChecksState" class="stint status-text">In attesa</span>
            <div id="technicalChecksLoader" class="stint loader hidden_my"></div>
            <i id="technicalChecksErrorIcon" class="fa-light fa-xmark icona stint hidden_my"></i>
        </p>
   </div>
<!--Generazione grafici -->
   <div class="flex items-center border-b border-gray-200 border-opacity-10">
    <p class="p stint" id="GraphsStatus">
        <span class="title_pipeline">Generazione grafici</span>
        <span id="GraphsState" class="stint status-text">In attesa</span>
        <div id="GraphsLoader" class="stint loader hidden_my"></div>
        <i id="GraphsSuccessIcon" class="stint hidden_my fa-regular fa-check icona"></i>
        <i id="GraphsErrorIcon" class="fa-light fa-xmark icona stint hidden_my"></i>
    </p>
</div>
   
    <!-- 8. Compilazione del progetto -->
   <div class="flex items-center border-b border-gray-200 border-opacity-10">
        <p class="p stint" id="projectCompilationStatus">
            <span class="title_pipeline">Compilazione del progetto</span>
            <span id="projectCompilationState" class="stint status-text">In attesa</span>
            <div id="projectCompilationLoader" class="stint loader hidden_my"></div>
            <i id="projectCompilationSuccessIcon" class="stint hidden_my fa-regular fa-check icona"></i>
            <i id="projectCompilationErrorIcon" class="fa-light fa-xmark icona stint hidden_my"></i>
        </p>
   </div>

   <!-- 9. Validazione -->
   <div class="flex items-center border-b border-gray-200 border-opacity-10">
        <p class="p stint" id="validationStatus">
            <span class="title_pipeline">Validazione</span>
            <span id="validationState" class="stint status-text">In attesa</span>
            <div id="validationLoader" class="stint loader hidden_my"></div>
            <i id="validationErrorIcon" class="text-red-700 fa-light fa-xmark icona stint hidden_my"></i>
            
        </p>
   </div>

   <!-- 10. Salvataggio file -->
   <div class="flex items-center border-b border-gray-200 border-opacity-10">
        <p class="p stint" id="fileSaveStatus">
            <span class="title_pipeline">Salvataggio file</span>           
            <span id="fileSaveState" class="stint status-text">In attesa</span>
            <div id="fileSaveLoader" class="stint loader hidden_my"></div>
            <i id="fileSaveErrorIcon" class="fa-light fa-xmark icona stint hidden_my"></i>
    
        </p>
   </div>

   <!-- Button -->
   <div class="flex gap-x-1 justify-center w-full">
       <button id="viewResultsButton" class="mt-5 disabled btn-primary btn hidden_my" style="margin-right: 0px !important;" onclick="goToDashboard()">
           Visualizza i risultati
       </button>
       <button id="errorResultsButton" class="mt-5 disabled btn-primary btn hidden_my" style="margin-right: 0px !important;" onclick="returnToDashboard()">
        Torna alla report page
       </button>
       <button id="refreshButton" class="mt-5 disabled btn-primary btn hidden_my" style="margin-right: 0px !important;" onclick="refreshPage()">
        Riprova
       </button>
   </div>
</div>

<script>
    const projectData = {
        latitude: parseFloat('{{ latitude|escapejs }}'),
        project: '{{ project }}',
        longitude: parseFloat('{{ longitude|escapejs }}'),
        projectCode: parseFloat('{{ project_code|escapejs }}'),
        projectId: '{{ project.id }}'
    };
 
    const stintHandlers = {
        prepData: {
            url: '/preparing_data/',
            elements: {
                state: document.getElementById('prepDataState'),
                loader: document.getElementById('prepDataLoader'),
                errorIcon: document.getElementById('prepDataErrorIcon'),
                warningIcon: document.getElementById('prepDataWarningIcon')
            }
        },
        sizing: {
            url: '/sizing/',
            elements: {
                state: document.getElementById('sizingState'),
                loader: document.getElementById('sizingLoader'),
                errorIcon: document.getElementById('sizingErrorIcon'),
                warningIcon: document.getElementById('sizingWarningIcon')
            }
        },
        solarCalculator: {
            url: '/solar_calculator/',
            elements: {
                state: document.getElementById('solarCalculatorState'),
                loader: document.getElementById('solarCalculatorLoader'),
                errorIcon: document.getElementById('solarCalculatorErrorIcon'),
                warningIcon: document.getElementById('solarCalculatorWarningIcon')
            }
        },
        pvgis: {
            url: '/pvgis/',
            elements: {
                state: document.getElementById('pvgisState'),
                loader: document.getElementById('pvgisLoader'),
                errorIcon: document.getElementById('pvgisErrorIcon'),
                warningIcon: document.getElementById('pvgisWarningIcon')
            }
        },
        cashflow: {
            url: '/cashflow/',
            elements: {
                state: document.getElementById('cashflowState'),
                loader: document.getElementById('cashflowLoader'),
                errorIcon: document.getElementById('cashflowErrorIcon'),
                warningIcon: document.getElementById('cashflowWarningIcon')
            }
        },
        pvGenerator: {
            url: '/pv_generator/',
            elements: {
                state: document.getElementById('pvGeneratorState'),
                loader: document.getElementById('pvGeneratorLoader'),
                errorIcon: document.getElementById('pvGeneratorErrorIcon'),
                warningIcon: document.getElementById('pvGeneratorWarningIcon')
            }
        },
        technicalChecks: {
            url: '/technical_checks/',
            elements: {
                state: document.getElementById('technicalChecksState'),
                loader: document.getElementById('technicalChecksLoader'),
                errorIcon: document.getElementById('technicalChecksErrorIcon'),
                warningIcon: document.getElementById('technicalChecksWarningIcon')
            }
        },
        GraphGenerator: {
            url: '/graph_generator/',
            elements: {
                state: document.getElementById('GraphsState'),
                loader: document.getElementById('GraphsLoader'),
                errorIcon: document.getElementById('GraphsErrorIcon'),
                warningIcon: document.getElementById('GraphsWarningIcon')
            }
        },
        projectCompilation: {
            url: '/project_compilation/',
            elements: {
                state: document.getElementById('projectCompilationState'),
                loader: document.getElementById('projectCompilationLoader'),
                errorIcon: document.getElementById('projectCompilationErrorIcon'),
                warningIcon: document.getElementById('projectCompilationWarningIcon')
            }
        },
        validation: {
            url: '/validation/',
            elements: {
                state: document.getElementById('validationState'),
                loader: document.getElementById('validationLoader'),
                errorIcon: document.getElementById('validationErrorIcon'),
                warningIcon: document.getElementById('validationWarningIcon')
            }
        },
        fileSave: {
            url: '/file_save/',
            elements: {
                state: document.getElementById('fileSaveState'),
                loader: document.getElementById('fileSaveLoader'),
                errorIcon: document.getElementById('fileSaveErrorIcon'),
                warningIcon: document.getElementById('fileSaveWarningIcon')
            }
        }
    };
 
    function handleStintStart(stintName) {
        const stint = stintHandlers[stintName];
        stint.elements.state.textContent = "In corso";
        stint.elements.state.style.display = 'none';
        stint.elements.loader.classList.remove('hidden_my');
    }
 
    function handleStintSuccess(stintName) {
        const stint = stintHandlers[stintName];
        stint.elements.loader.classList.add('hidden_my');
        stint.elements.state.innerHTML = `Terminato <svg width="19" height="16" viewBox="0 0 19 16" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M6.21 15.54L0 9.33L2.83 6.5L6.21 9.89L16.09 0L18.92 2.83L6.21 15.54Z" fill="#FFE182"/>
</svg>
`;
        stint.elements.state.style.display = 'flex';
    }
 
    function handleStintError(stintName) {
        const stint = stintHandlers[stintName];
        stint.elements.loader.classList.add('hidden_my');
        stint.elements.state.innerHTML = `Errore <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M3 3L15 15" stroke="#ED2E7E" stroke-width="3" stroke-linecap="square" stroke-linejoin="round"/>
<path d="M3 15L15 3.00002" stroke="#ED2E7E" stroke-width="3" stroke-linecap="square" stroke-linejoin="round"/>
</svg>

`
        stint.elements.state.style.display = 'flex';
        stint.elements.state.style.setProperty('color', '#ED2E7E', 'important');
        

        const btn = document.getElementById('viewResultsButton');
        btn.classList.add('hidden_my')
    }
 
    function handleStintWarning(stintName) {
        const stint = stintHandlers[stintName];
        stint.elements.loader.classList.add('hidden_my');
        stint.elements.state.innerHTML = `Warning <svg width="22" height="19" viewBox="0 0 22 19" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M11 0L0 19H22M11 4L18.53 17H3.47M10 8V12H12V8M10 14V16H12V14" fill="#FFE182"/>
</svg>

`;
        stint.elements.state.style.display = 'flex';

    }
 
    async function executeStints() {
       const stintNames = Object.keys(stintHandlers);
       const statusResults = {}
       // Inizializza tutti gli stint come "In attesa"
       stintNames.forEach(stintName => {
           const stint = stintHandlers[stintName];
           stint.elements.state.textContent = "In attesa";
           stint.elements.state.style.display = 'inline';
       });
       
       for (let i = 0; i < stintNames.length; i++) {
           const stintName = stintNames[i];
           console.log(`Executing ${stintName}`);
           
           handleStintStart(stintName);
           
           try {
               const formData = new FormData();
               formData.append('project_id', projectData.projectId);
               formData.append('project_code', projectData.projectCode);
               const response = await fetch(stintHandlers[stintName].url, {
                   method: 'POST',
                   body: formData,
                   headers: {
                       'X-CSRFToken': getCookie('csrftoken')
                   }
               });

               const data = await response.json();
               statusResults[stintName] = data.status;
               console.log(statusResults)
               console.log(response.status)
               // Gestisci i diversi codici di stato
               if (data.status === 405) {
                   console.log(`${stintName} warning (405)`);
                   handleStintWarning(stintName);
                   continue;  // Continua con il prossimo stint
               } else if (data.status === 500) {
                   console.log(`${stintName} error (500)`);
                   handleStintError(stintName);
                   break;  // Interrompi l'esecuzione
               } else if (data.status !== 200) {
                   console.log(`${stintName} other error (${data.status})`);
                   handleStintError(stintName);
                   continue;
               }

               handleStintSuccess(stintName);
               await new Promise(resolve => setTimeout(resolve, 1000));
               
           } catch (error) {
               console.error(`Failed at stint ${stintName}:`, error);
               handleStintError(stintName);
               if (error.status === 500) {
                   break;  // Interrompi l'esecuzione su errore 500
               }
           }
       }

       // Controlla gli status alla fine del ciclo
       const has500Error = Object.values(statusResults).some(status => status === 500);
       console.log('Status finali:', statusResults);
       console.log('Trovato errore 500:', has500Error);

       if (has500Error) {
           console.log('Nascondo il pulsante per errore 500');
           document.getElementById('viewResultsButton').classList.add('hidden_my');
           document.getElementById('errorResultsButton').classList.remove('hidden_my');
           document.getElementById('refreshButton').classList.remove('hidden_my');
       } else {
           console.log('Mostro il pulsante');
           document.getElementById('viewResultsButton').classList.remove('hidden_my');
       }
   }
 
    function goToDashboard() {
        window.location.href = '/project/dashboard_result';
    }
    function returnToDashboard() {
        window.location.href = '/project/report_page';
    }
 
    function refreshPage() {
        location.reload();
    }
 
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
 
    window.addEventListener('load', executeStints);
 </script>

<style>
    .hidden_my {
        display: none !important;
    }
 

    .title_pipeline{
        min-width: 250px !important;
        display: inline-block;
    }
    .stint{
        display: flex;
        margin-bottom: 20px;
        font-size: 16px;
        height: 20px;
    }
    
    .status-text {
        display: flex;
        align-items: center;
        min-width: 150px;
        color: #FFE182;
    }
    .status-text svg{
        margin-left: 10px;
    }
    
    .icona {
        margin-left: 10px;
    }
    
    /* Loader animation */
    .loader {
       height: 10px;
       width: 130px;
       border-radius: 20px;
       --c:no-repeat linear-gradient(#f0b90b 0 0);
       background: var(--c),var(--c),#FFF1C3;
       background-size: 60% 100%;
       animation: l16 3s infinite;
    }
    
    @keyframes l16 {
       0%   {background-position:-150% 0,-150% 0}
       66%  {background-position: 250% 0,-150% 0}
       100% {background-position: 250% 0, 250% 0}
    }
 
    .warning-icon {
        color: #f0b90b;  /* Colore giallo per i warning */
    }
 
    /* Stile per il pulsante dei risultati */
    .next_bt_down5 {
        margin-top: 20px;
    }
 
    /* Flex container styles */
    .flex {
        display: flex;
    }
 
    .items-center {
        align-items: center;
    }
 </style>
 {% endblock %}