{% extends "layout_project_archive.html" %}
{% block title %}Archivio Progetti{% endblock %}
{% block content %}
{% load static %}

<div class="py-[20px] md:py-[100px] inner_form_div" style="width: 80% !important; margin: 0 auto;">
   <h1 class="mb-[50px] text-center h2">Archivio Progetti</h1>
   {% if projects %}
   <!-- Contenitore per la visualizzazione dei progetti archiviati -->
    <div class="flex mb-10">
        <div class="left">
            <h2 class="h3">Titolo e data progetto</h2>
        </div>
        <div class="right">
            <h2 class="h3">Azioni sul progetto</h2>
        </div>
    </div>
   <div class="outer_project">
    
   {% for project in projects %}
       <div class="project_div">
        <div class="left">
            
            <p class="p" style="font-size: 12px; margin-bottom: -10px;">{{ project.project_date }}</p>
            <p class="font-normal h3">{{ project.project_title }}</p>
        </div>
        <div class="right">
            
            <a href="/dashboard_result/{{ project.project_code }}" class="text-[#efb90b] mr-[10px] hover:underline">Visualizza</a>
            <button onclick="showDeletePopup('{{ project.project_code }}')" class="text-red-500 ml-[10px] hover:underline">Elimina</button>
        </div>
       </div>
   {% endfor %}
   {% else %}
   <h2 class="text-center h2">Nessun progetto da visualizzare</h2>
   {% endif %}
</div>
   <div id="delete_popup" style="display: none;">
    <div id="inner_del_popup" class="flex flex-col items-center gap-y-5 popup-content sfondo h-[300px] w-[500px] leading-4">
        <h3 class="h3 pt-[20px] pb-[20px]" style="line-height: 110%; text-align: center;">Sei sicuro di voler eliminare<br>questo progetto?</h3>
        <p class="p pb-[20px]" style="line-height: 110%; text-align: center;">Una volta eliminato il progetto<br>non sarà più possibile recuperarlo.</p>
        <div class="flex items-center gap-x-4 pb-[20px]">
            <button onclick="closeDeletePopup()" class="flex gap-x-3 items-center border_button_general">
                <img src="{% static 'image/icons/x.svg' %}" alt=""> Annulla
            </button>
            <button onclick="confirmDelete()" class="flex gap-x-3 items-center button_general p">
                <i class="text-red fa-light fa-trash dark:text-red"></i>Elimina 
            </button>
        </div>
        <div class="hidden bg-black loader" id="loader"></div>
    </div>
</div>

</div>

<script>

let currentProjectCode = null;

function showDeletePopup(projectCode) {
    currentProjectCode = projectCode;
    document.getElementById('delete_popup').style.display = 'flex';
}

function closeDeletePopup() {
    document.getElementById('delete_popup').style.display = 'none';
    currentProjectCode = null;
}

function confirmDelete() {
    if (currentProjectCode) {
        const csrftoken = getCookie('csrftoken');
        let loader = document.getElementById('loader');
        let inner_del_popup = document.getElementById('inner_del_popup')
        loader.classList.remove('hidden');
        inner_del_popup.classList.add('h-[400px]')
        fetch(`/delete_project/${currentProjectCode}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Errore nella richiesta');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                window.location.reload();
                closeDeletePopup();
            } else {
                alert(data.message || 'Si è verificato un errore');
            }
        })
        .catch(error => {
            console.error('Errore:', error);
            alert('Si è verificato un errore durante l\'eliminazione del progetto');
        });
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
<style>
    #delete_popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.popup-content {
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px #051626;
}

/* Dark mode support for popup */
.dark .popup-content {
    background-color: #051626;
    color: white;
}
/* Loader animation */
.loader {
  width: 50px;
  aspect-ratio: 1;
  border-radius: 50%;
  background: 
    radial-gradient(farthest-side,#ffa516 94%,#0000) top/8px 8px no-repeat,
    conic-gradient(#0000 30%,#ffa516);
  -webkit-mask: radial-gradient(farthest-side,#0000 calc(100% - 8px),#000 0);
  animation: l13 1s infinite linear;
}
@keyframes l13{ 
  100%{transform: rotate(1turn)}
}

/* Mobile responsiveness improvements */
@media (max-width: 768px) {
    .popup-content {
        width: 90% !important;
        height: auto !important;
        padding: 15px;
    }
    
    #projectGrid {
        height: 400px !important;
    }
}


.project_div{
    display: flex;
    border-bottom: 2px solid #efba0baa;
}
.left{
    width: 70%;
    margin-bottom: 15px;
    margin-top: 15px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.right{
    width: 30%;
    margin-bottom: 15px;
    margin-top: 15px;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;

}
</style>
{% endblock %}
